# PostgreSQL 17 vs 18 verification report (2025-09-28)

## 環境
- ホスト: Docker Compose を利用し、`postgres:17` と `postgres:18` イメージを起動。
- コンテナのポート: PostgreSQL 17 を `localhost:5417`, PostgreSQL 18 を `localhost:5418` に割り当て。
- レポジトリパスをコンテナへ `/workspace` として読み込み専用マウントし、`scenarios/` 配下の SQL を直接実行。
- 各セクションのログは `scenarios/<scenario>/output-*.txt` に保存。

## シナリオ別結果

### 1. マルチカラム B-tree のスキップスキャン
- PostgreSQL 17 は `product_id` のみのフィルタでシーケンシャルスキャンを選択し、実行時間は約 2.7ms・バッファヒット 589。(`scenarios/skip-scan/output-pg17.txt:12`)
- PostgreSQL 18 は同条件で `Index Scan using skip_scan_demo_pk` を採用し、約 0.56ms で完了。`Index Searches: 191` などスキップスキャン特有の統計が現れる。(`scenarios/skip-scan/output-pg18.txt:12`)
- 選択性を追加しても PostgreSQL 18 はインデックススキャンを維持し、0.28ms まで短縮できる一方、17 は 3.0ms 前後でフルスキャン継続。(`scenarios/skip-scan/output-pg17.txt:26`, `scenarios/skip-scan/output-pg18.txt:26`)

### 2. `uuidv7()` の組み込みサポート
- PostgreSQL 17 は `uuidv7()` 呼び出しで「function uuidv7() does not exist」というエラーになり、標準では未実装。(`scenarios/uuidv7/output-pg17.txt:9`)
- PostgreSQL 18 は 5 件の UUID を即時生成し、そのまま並べても時系列順を保つ。(`scenarios/uuidv7/output-pg18.txt:10`)

### 3. `RETURNING OLD/NEW`
- PostgreSQL 17 で `RETURNING OLD.balance` を使うと `missing FROM-clause entry for table "old"` エラーが発生。(`scenarios/returning-old-new/output-pg17.txt:12`)
- PostgreSQL 18 では `before_balance`/`after_balance` を同一クエリで取得でき、UPDATE をロールバックする前に差分が確認可能。(`scenarios/returning-old-new/output-pg18.txt:12`)

### 4. 非同期 I/O サブシステム
- PostgreSQL 17 は `io_method` や `io_max_combine_limit` を GUC として認識せず、`pg_aios` ビューも存在しない。(`scenarios/async-io/output-pg17.txt:5`)
- PostgreSQL 18 は `io_method = worker` を返し、`pg_aios` ビューにアクセス可能（テスト時点では行なし）。(`scenarios/async-io/output-pg18.txt:4`, `scenarios/async-io/output-pg18.txt:23`)

### 5. データチェックサム初期状態
- PostgreSQL 17 の新規クラスタは `data_checksums = off`。(`scenarios/data-checksums/output-pg17.txt:6`)
- PostgreSQL 18 では `data_checksums = on` がデフォルトで、`data_directory` も別パスで初期化。(`scenarios/data-checksums/output-pg18.txt:6`)
- 両バージョンとも `pg_control_system` ビューは存在しなかったため、低レベル情報の確認には別ツールが必要。(`scenarios/data-checksums/output-pg17.txt:11`, `scenarios/data-checksums/output-pg18.txt:11`)

## 所感とフォローアップ
- スキップスキャンと `RETURNING OLD/NEW` は即座に成果が確認できたため、既存アプリのクエリ・監査ロジックへ適用余地が大きい。
- 非同期 I/O とデータチェックサムは設定・運用に関わる変更なので、本番導入前に `postgresql.conf` の変更や `pgbench` による負荷テストの追加検証が望ましい。
- 追加候補: Temporal 制約や `pg_upgrade` 統計保持、OAuth 認証など運用寄りの機能を後続レポートで扱う。
